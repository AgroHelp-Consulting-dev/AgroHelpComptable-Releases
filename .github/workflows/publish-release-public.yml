name: Build Windows + Publish to Public Releases Repo

on:
  push:
    tags:
      - "v*"

jobs:
  build_and_publish:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build (PyInstaller)
        shell: pwsh
        run: |
          pyinstaller --onedir --windowed --name AgroHelpComptable `
            -i src\agrohelp_comptable\assets\images\agrohelp.ico `
            --add-data "src\agrohelp_comptable\assets;agrohelp_comptable\assets" `
            src\agrohelp_comptable\main.py

      # ✅ Compile ton setup Inno Setup (il te faut un installer.iss dans ton repo privé)
      - name: Compile Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: installer/installer.iss

      - name: Compute SHA256 (setup)
        shell: pwsh
        run: |
          $setup = Get-ChildItem -Path installer_output -Filter *.exe | Select-Object -First 1
          if (-not $setup) { throw "No setup exe found in installer_output/" }
          certutil -hashfile $setup.FullName SHA256 | Out-File -Encoding utf8 sha.txt
          $setup.Name | Out-File -Encoding utf8 setup_name.txt

      - name: Publish to public releases repo
        shell: pwsh
        env:
          TOKEN: ${{ secrets.RELEASES_REPO_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          git config --global user.email "ci@github"
          git config --global user.name "ci-bot"

          $publicRepo = "https://x-access-token:$env:TOKEN@github.com/AgroHelp-Consulting-dev/AgroHelpComptable-Releases.git"
          git clone $publicRepo public-releases
          cd public-releases

          $version = $env:TAG.TrimStart("v")

          # dossier versionné
          New-Item -ItemType Directory -Force -Path $env:TAG | Out-Null

          $setupName = (Get-Content ..\setup_name.txt).Trim()
          Copy-Item ..\installer_output\$setupName $env:TAG\ -Force

          # récupère le hash
          $hash = (Get-Content ..\sha.txt | Select-String -Pattern "^[0-9A-Fa-f]{64}$").Line
          if (-not $hash) { $hash = "" }

          # URL raw github (public) vers le setup
          $installerUrl = "https://raw.githubusercontent.com/AgroHelp-Consulting-dev/AgroHelpComptable-Releases/main/$env:TAG/$setupName"

          $latest = @{
            version = $version
            notes = "Release $env:TAG"
            windows = @{
              installer_url = $installerUrl
              sha256 = $hash.ToLower()
            }
          } | ConvertTo-Json -Depth 5

          $latest | Out-File -Encoding utf8 latest.json

          git add .
          git commit -m "release: $env:TAG"
          git push
